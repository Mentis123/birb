<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Gyroscope Test - AR Shooter</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #1a1a2e;
        }

        #canvas {
            display: block;
        }

        .overlay-info {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.85em;
            font-family: monospace;
            z-index: 10;
        }

        .overlay-info div {
            margin: 5px 0;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 10;
        }

        .permission-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            max-width: 350px;
        }

        .permission-prompt h2 {
            margin-bottom: 15px;
            color: #333;
        }

        .permission-prompt p {
            margin-bottom: 20px;
            color: #666;
            line-height: 1.5;
        }

        .permission-prompt button {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        .status-ok { color: #4CAF50; }
        .status-warn { color: #FF9800; }
        .status-error { color: #f44336; }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">← Back</a>

    <canvas id="canvas"></canvas>

    <div class="overlay-info" id="info">
        <div><strong>Gyroscope Test</strong></div>
        <div id="status">Initializing...</div>
        <div id="alpha">Alpha (Z): --</div>
        <div id="beta">Beta (X): --</div>
        <div id="gamma">Gamma (Y): --</div>
        <div id="device-info"></div>
    </div>

    <div class="permission-prompt hidden" id="permissionPrompt">
        <h2>Motion Permission Required</h2>
        <p>This app needs access to your device's gyroscope to track orientation in AR.</p>
        <button id="requestPermission">Enable Gyroscope</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="js/gyro.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const statusDiv = document.getElementById('status');
        const alphaDiv = document.getElementById('alpha');
        const betaDiv = document.getElementById('beta');
        const gammaDiv = document.getElementById('gamma');
        const deviceInfoDiv = document.getElementById('device-info');
        const permissionPrompt = document.getElementById('permissionPrompt');
        const requestBtn = document.getElementById('requestPermission');

        // Three.js scene setup
        let scene, camera, renderer, cube;
        let gyroActive = false;

        function initThreeJS() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Cube
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshPhongMaterial({
                color: 0x667eea,
                shininess: 100
            });
            cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            // Edges for better visibility
            const edges = new THREE.EdgesGeometry(geometry);
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0xffffff });
            const wireframe = new THREE.LineSegments(edges, lineMaterial);
            cube.add(wireframe);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // Handle resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Start animation
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);

            // If gyro not active, rotate cube automatically
            if (!gyroActive) {
                cube.rotation.x += 0.01;
                cube.rotation.y += 0.01;
            }

            renderer.render(scene, camera);
        }

        // Detect device
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        deviceInfoDiv.textContent = `Device: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Unknown'}`;

        // Handle orientation data
        function handleOrientation(event) {
            const alpha = event.alpha || 0;  // Z axis (0-360)
            const beta = event.beta || 0;    // X axis (-180 to 180)
            const gamma = event.gamma || 0;   // Y axis (-90 to 90)

            alphaDiv.textContent = `Alpha (Z): ${alpha.toFixed(1)}°`;
            betaDiv.textContent = `Beta (X): ${beta.toFixed(1)}°`;
            gammaDiv.textContent = `Gamma (Y): ${gamma.toFixed(1)}°`;

            // Update cube rotation based on device orientation
            if (cube) {
                // Convert to radians and apply to cube
                cube.rotation.z = alpha * (Math.PI / 180);
                cube.rotation.x = beta * (Math.PI / 180);
                cube.rotation.y = gamma * (Math.PI / 180);
            }

            if (!gyroActive) {
                gyroActive = true;
                statusDiv.textContent = '✓ Gyroscope active';
                statusDiv.className = 'status-ok';
            }
        }

        // iOS permission request
        async function requestIOSPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                        permissionPrompt.classList.add('hidden');
                        statusDiv.textContent = 'Waiting for orientation data...';
                        statusDiv.className = 'status-warn';
                        return true;
                    } else {
                        statusDiv.textContent = '✗ Permission denied';
                        statusDiv.className = 'status-error';
                        return false;
                    }
                } catch (error) {
                    console.error('Permission request error:', error);
                    statusDiv.textContent = `✗ Error: ${error.message}`;
                    statusDiv.className = 'status-error';
                    return false;
                }
            }
            return false;
        }

        // Android - direct access
        function startAndroidGyro() {
            window.addEventListener('deviceorientation', handleOrientation);
            statusDiv.textContent = 'Waiting for orientation data...';
            statusDiv.className = 'status-warn';
        }

        // Initialize
        initThreeJS();

        // Check gyroscope support
        if (!('DeviceOrientationEvent' in window)) {
            statusDiv.textContent = '✗ Gyroscope not supported';
            statusDiv.className = 'status-error';
        } else if (isIOS && typeof DeviceOrientationEvent.requestPermission === 'function') {
            // iOS 13+ requires permission
            statusDiv.textContent = 'iOS device - permission required';
            statusDiv.className = 'status-warn';
            permissionPrompt.classList.remove('hidden');
            requestBtn.addEventListener('click', requestIOSPermission);
        } else {
            // Android or older iOS
            startAndroidGyro();
        }

        // Test without gyro - show manual rotation
        setTimeout(() => {
            if (!gyroActive) {
                statusDiv.textContent = '⚠ No gyro data - showing demo rotation';
                statusDiv.className = 'status-warn';
            }
        }, 3000);
    </script>
</body>
</html>
