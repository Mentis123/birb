<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local AI Test Grader | Data#3 Workshop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --data3-teal: #00a0af;
            --data3-teal-light: #00c4d4;
            --data3-teal-dark: #007a87;
            --accent-purple: #7c3aed;
            --success: #3fb950;
            --error: #f85149;
            --warning: #d29922;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .header-brand { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px; }
        .header-brand svg { height: 32px; }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .header-subtitle { font-size: 0.875rem; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; font-size: 0.75rem; color: var(--data3-teal-light); }
        .badge::before { content: ''; width: 6px; height: 6px; background: var(--data3-teal); border-radius: 50%; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; font-weight: 600; font-size: 0.9rem; }
        .card-header .step-num { display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: var(--data3-teal); color: white; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .upload-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .upload-area:hover { border-color: var(--data3-teal); background: rgba(0, 160, 175, 0.05); }
        .upload-area.has-image { padding: 12px; border-style: solid; border-color: var(--data3-teal); }
        .upload-area input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .upload-icon { font-size: 2rem; margin-bottom: 8px; }
        .upload-text { color: var(--text-secondary); font-size: 0.875rem; }
        .upload-text strong { color: var(--data3-teal-light); }
        .img-preview { max-width: 100%; max-height: 350px; border-radius: 8px; display: none; margin-top: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        textarea { width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: 'SF Mono', 'Consolas', monospace; font-size: 0.875rem; resize: none; transition: border-color 0.2s; }
        textarea:focus { outline: none; border-color: var(--data3-teal); }
        .input-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; }
        .grade-section { text-align: center; }
        .button-row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .grade-btn { flex: 1; max-width: 240px; padding: 16px 24px; border: none; border-radius: 10px; font-family: inherit; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .grade-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .grade-btn .btn-icon { font-size: 1.5rem; margin-bottom: 2px; }
        .grade-btn .btn-label { font-size: 0.9rem; }
        .grade-btn .btn-sub { font-size: 0.7rem; font-weight: 400; opacity: 0.8; }
        .grade-btn.ocr-llm { background: linear-gradient(135deg, var(--data3-teal), var(--data3-teal-dark)); color: white; }
        .grade-btn.ocr-llm:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 160, 175, 0.3); }
        .grade-btn.vision { background: linear-gradient(135deg, var(--accent-purple), #9333ea); color: white; }
        .grade-btn.vision:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(168, 85, 247, 0.3); }
        .grade-btn.validate { background: linear-gradient(135deg, var(--data3-teal), #9333ea); color: white; }
        .grade-btn.validate:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 160, 175, 0.3); }
        #statusBox { display: none; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; margin-top: 16px; text-align: center; }
        #statusBox.error { border-color: var(--error); background: rgba(248, 81, 73, 0.1); }
        #statusBox.success { border-color: var(--success); background: rgba(63, 185, 80, 0.1); }
        .spinner-container { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--bg-tertiary); border-top: 3px solid var(--data3-teal); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .spinner.vision { border-top-color: var(--accent-purple); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .brain-icon { font-size: 1.75rem; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.05); } }
        #statusMessage { font-weight: 500; margin-bottom: 8px; }
        .progress-bar { width: 100%; height: 6px; background: var(--bg-primary); border-radius: 3px; overflow: hidden; margin: 12px 0 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--data3-teal), var(--data3-teal-light)); border-radius: 3px; transition: width 0.3s ease; width: 0%; }
        #statusStep { font-size: 0.8rem; color: var(--text-secondary); }
        #output { display: none; }
        .method-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; margin-bottom: 16px; }
        .method-badge.method-ocr-llm { background: rgba(0, 160, 175, 0.15); color: var(--data3-teal-light); border: 1px solid rgba(0, 160, 175, 0.3); }
        .method-badge.method-vision { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); border: 1px solid rgba(168, 85, 247, 0.3); }
        .score-card { background: linear-gradient(135deg, var(--data3-teal-dark), var(--data3-teal)); border-radius: 12px; padding: 24px; text-align: center; margin-bottom: 20px; }
        .score-value { font-size: 3rem; font-weight: 700; color: white; }
        .score-percent { font-size: 1.25rem; color: rgba(255, 255, 255, 0.9); margin-top: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        tr.correct { background: rgba(63, 185, 80, 0.1); }
        tr.incorrect { background: rgba(248, 81, 73, 0.1); }
        .debug-section { margin-top: 20px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .debug-section summary { padding: 12px 16px; background: var(--bg-tertiary); cursor: pointer; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary); }
        .debug-section summary:hover { color: var(--text-primary); }
        #debugContent { padding: 16px; font-size: 0.85rem; }
        #debugContent h4 { font-size: 0.8rem; color: var(--text-secondary); margin: 16px 0 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .detected-answers { display: flex; flex-wrap: wrap; gap: 8px; }
        .detected-answer { padding: 6px 12px; background: var(--bg-tertiary); border-radius: 6px; font-family: monospace; font-size: 0.85rem; }
        .detected-answer.matched { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .detected-answer.unmatched { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        #debugContent pre { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; overflow: auto; max-height: 300px; font-size: 0.8rem; color: var(--text-secondary); white-space: pre-wrap; word-wrap: break-word; }
        .footer { text-align: center; padding: 20px; margin-top: 24px; border-top: 1px solid var(--border-color); color: var(--text-muted); font-size: 0.75rem; }
        .footer-icons { display: flex; justify-content: center; gap: 20px; margin-bottom: 8px; font-size: 0.8rem; color: var(--text-secondary); }
        .footer-icons span { display: flex; align-items: center; gap: 6px; }
        canvas { display: none; }
        .config-section { margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; }
        .config-section label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .config-section input { width: 100%; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: monospace; font-size: 0.85rem; }
        .config-section input:focus { outline: none; border-color: var(--data3-teal); }
        .model-list { margin-top: 8px; font-size: 0.75rem; color: var(--text-muted); }
        .model-list button { background: var(--data3-teal); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; margin-right: 8px; }
        .model-list button:hover { background: var(--data3-teal-light); }
        @media (max-width: 640px) { .grade-btn { max-width: none; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-brand">
                <svg viewBox="0 0 100 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <text x="0" y="22" font-family="Inter, sans-serif" font-size="22" font-weight="700" fill="#00a0af">Data</text>
                    <text x="50" y="14" font-family="Inter, sans-serif" font-size="12" font-weight="700" fill="#00a0af">#</text>
                    <text x="60" y="22" font-family="Inter, sans-serif" font-size="22" font-weight="700" fill="#00a0af">3</text>
                </svg>
                <h1>Local AI Test Grader</h1>
            </div>
            <p class="header-subtitle">
                <span class="badge">On-Device AI</span>
                Secure grading that never leaves your machine
            </p>
        </header>

        <div class="card">
            <div class="card-header"><span class="step-num">‚öô</span> Foundry Local Configuration</div>
            <div class="config-section">
                <label>Foundry Local API Base URL</label>
                <input type="text" id="apiBase" value="http://127.0.0.1:5272" placeholder="http://127.0.0.1:5272">
                <div class="model-list">
                    <button onclick="listModels()">üîÑ List Available Models</button>
                    <span id="modelListStatus"></span>
                </div>
                <div id="availableModels" style="margin-top: 8px;"></div>
            </div>
            <div class="config-section">
                <label>Text Model (for OCR analysis)</label>
                <input type="text" id="textModelInput" value="DeepSeek-R1-Distill-Qwen-7B" placeholder="e.g., DeepSeek-R1-Distill-Qwen-7B">
            </div>
            <div class="config-section">
                <label>Vision Model (for direct image analysis)</label>
                <input type="text" id="visionModelInput" value="Qwen2.5-VL-7B-Instruct" placeholder="e.g., Qwen2.5-VL-7B-Instruct">
            </div>
        </div>

        <div class="card">
            <div class="card-header"><span class="step-num">1</span> Upload Student Paper</div>
            <div class="upload-area" id="uploadArea">
                <input type="file" id="imageUpload" accept="image/*">
                <div class="upload-placeholder">
                    <div class="upload-icon">üìÑ</div>
                    <p class="upload-text"><strong>Click to upload</strong> or drag and drop</p>
                </div>
                <img id="imgPreview" class="img-preview" alt="Student paper preview">
            </div>
            <canvas id="canvas"></canvas>
        </div>

        <div class="card">
            <div class="card-header"><span class="step-num">2</span> Answer Key</div>
            <div class="input-wrapper">
                <textarea id="answerKey" rows="2" placeholder="1:B,2:A,3:C,4:B,5:B">1:B,2:A,3:C,4:B,5:B</textarea>
                <p class="input-hint">Format: QuestionNum:Answer ‚Äî e.g., 1:B,2:A,3:C</p>
            </div>
        </div>

        <div class="card grade-section">
            <div class="card-header"><span class="step-num">3</span> Grade Paper</div>
            <div class="button-row">
                <button id="ocrLlmBtn" class="grade-btn ocr-llm">
                    <span class="btn-icon">üß†</span>
                    <span class="btn-label">OCR + LLM</span>
                    <span class="btn-sub">DeepSeek R1 Distill Qwen 7B (NPU)</span>
                </button>
                <button id="visionBtn" class="grade-btn vision">
                    <span class="btn-icon">üëÅÔ∏è</span>
                    <span class="btn-label">Vision AI</span>
                    <span class="btn-sub">Qwen2.5-VL direct handwriting</span>
                </button>
                <button id="validateBtn" class="grade-btn validate">
                    <span class="btn-icon">‚úÖ</span>
                    <span class="btn-label">Validation Mode</span>
                    <span class="btn-sub">DeepSeek R1 + Qwen2.5-VL (recommended)</span>
                </button>
            </div>
            <div id="statusBox">
                <div class="spinner-container">
                    <div id="spinner" class="spinner"></div>
                    <span id="brainIcon" class="brain-icon">üß†</span>
                </div>
                <div id="statusMessage">Ready</div>
                <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
                <div id="statusStep"></div>
            </div>
        </div>

        <div id="output">
            <div class="card">
                <div id="methodBadge"></div>
                <div id="scoreBox"></div>
                <div id="gradeTable"></div>
                <details class="debug-section">
                    <summary>üîç Debug: Detection Details</summary>
                    <div id="debugContent"></div>
                </details>
            </div>
        </div>

        <footer class="footer">
            <div class="footer-icons">
                <span>üîí No Cloud</span>
                <span>üîë No API Keys</span>
                <span>üõ°Ô∏è Data Stays Local</span>
            </div>
            Powered by Microsoft Foundry ‚Ä¢ Data<sup>#</sup>3 AI Workshop
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
    <script>
        // ======= CONFIGURATION =======
        // Default Foundry Local port is 5272 (not 64579)
        // You can change this in the UI above

        let ocrWorker = null;
        let ocrReady = false;
        let imageBase64 = null;

        // Get API base from input field
        function getApiBase() {
            return document.getElementById('apiBase').value.trim() || 'http://127.0.0.1:5272';
        }

        function getTextModel() {
            return document.getElementById('textModelInput').value.trim() || 'DeepSeek-R1-Distill-Qwen-7B';
        }

        function getVisionModel() {
            return document.getElementById('visionModelInput').value.trim() || 'Qwen2.5-VL-7B-Instruct';
        }

        // List available models from Foundry Local
        async function listModels() {
            const statusEl = document.getElementById('modelListStatus');
            const modelsEl = document.getElementById('availableModels');
            statusEl.textContent = 'Fetching...';
            modelsEl.innerHTML = '';

            try {
                const response = await fetch(`${getApiBase()}/v1/models`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                statusEl.textContent = '‚úì Connected';
                statusEl.style.color = 'var(--success)';

                if (data.data && data.data.length > 0) {
                    modelsEl.innerHTML = '<strong style="color: var(--text-secondary); font-size: 0.75rem;">Available models:</strong><br>' +
                        data.data.map(m => `<code style="background: var(--bg-primary); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin: 2px; display: inline-block;">${m.id}</code>`).join(' ');
                } else {
                    modelsEl.innerHTML = '<span style="color: var(--warning);">No models loaded. Run: foundry model run &lt;model-name&gt;</span>';
                }
            } catch (err) {
                statusEl.textContent = '‚úó Connection failed';
                statusEl.style.color = 'var(--error)';
                modelsEl.innerHTML = `<span style="color: var(--error); font-size: 0.75rem;">Error: ${err.message}<br><br>
                    <strong>Troubleshooting:</strong><br>
                    1. Make sure Foundry Local is running: <code>foundry</code><br>
                    2. Load a model: <code>foundry model run DeepSeek-R1-Distill-Qwen-7B</code><br>
                    3. Check if API is at a different port (default is 5272)</span>`;
            }
        }

        // All helper functions first
        function showStatus(message, step = '', progress = null, isError = false, isSuccess = false, showSpinner = true, isVision = false) {
            const box = document.getElementById('statusBox');
            const spinner = document.getElementById('spinner');
            const brainIcon = document.getElementById('brainIcon');
            box.style.display = 'block';
            box.className = isError ? 'error' : (isSuccess ? 'success' : '');
            document.getElementById('statusMessage').textContent = message;
            document.getElementById('statusStep').textContent = step;
            if (progress !== null) document.getElementById('progressFill').style.width = progress + '%';
            if (isSuccess || isError) { spinner.style.display = 'none'; brainIcon.style.display = 'none'; }
            else if (showSpinner) { spinner.style.display = 'block'; spinner.className = isVision ? 'spinner vision' : 'spinner'; brainIcon.style.display = isVision ? 'inline-block' : 'none'; }
            else { spinner.style.display = 'none'; brainIcon.style.display = 'none'; }
        }

        function hideStatus() { document.getElementById('statusBox').style.display = 'none'; }

        function setButtonsDisabled(disabled) {
            document.getElementById('ocrLlmBtn').disabled = disabled;
            document.getElementById('visionBtn').disabled = disabled;
            document.getElementById('validateBtn').disabled = disabled;
        }

        // ======= FOUNDRY LOCAL API CALLS (OpenAI-compatible format) =======

        // Text completion using OpenAI chat completions endpoint
        async function callTextModel(model, prompt) {
            const apiBase = getApiBase();
            console.log(`Calling text model: ${model} at ${apiBase}/v1/chat/completions`);

            const response = await fetch(`${apiBase}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: "user", content: prompt }
                    ],
                    temperature: 0,
                    max_tokens: 1024
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Foundry API error:', errorText);
                throw new Error(`Foundry error (${response.status}): ${errorText}`);
            }

            const data = await response.json();
            console.log('Text model response:', data);
            return data.choices[0].message.content;
        }

        // Vision model using OpenAI chat completions with image
        async function callVisionModel(model, prompt, imageBase64Data) {
            const apiBase = getApiBase();
            console.log(`Calling vision model: ${model} at ${apiBase}/v1/chat/completions`);

            const response = await fetch(`${apiBase}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: prompt },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: `data:image/jpeg;base64,${imageBase64Data}`
                                    }
                                }
                            ]
                        }
                    ],
                    temperature: 0,
                    max_tokens: 1024
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Foundry Vision API error:', errorText);
                throw new Error(`Foundry vision error (${response.status}): ${errorText}`);
            }

            const data = await response.json();
            console.log('Vision model response:', data);
            return data.choices[0].message.content;
        }

        async function initOCR() {
            if (ocrReady) return;
            showStatus('Initializing OCR engine...');
            ocrWorker = await Tesseract.createWorker('eng', 1, { logger: () => {} });
            await ocrWorker.setParameters({ preserve_interword_spaces: '1' });
            ocrReady = true;
        }

        function extractAnswersFromTextBlob(text, numQuestions) {
            const answers = {};
            if (!text) return answers;

            // Try JSON extraction first
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                try {
                    const obj = JSON.parse(jsonMatch[0]);
                    const node = obj.answers || obj;
                    if (node && typeof node === 'object') {
                        for (const [k, v] of Object.entries(node)) {
                            const q = parseInt(k, 10);
                            const letter = String(v).trim().toUpperCase().charAt(0);
                            if (q >= 1 && q <= numQuestions && /[A-D]/.test(letter)) answers[q] = letter;
                        }
                    }
                } catch (e) {
                    console.log('JSON parse failed, trying line-by-line');
                }
            }

            // Line-by-line pattern matching
            const lines = text.split('\n');
            const linePattern = /^(?:\s*(?:Q|Question)?\s*)?(\d+)[.)\]:\-=\s]*([A-D])/i;
            for (const line of lines) {
                const m = line.match(linePattern);
                if (m) {
                    const q = parseInt(m[1], 10);
                    const letter = m[2].toUpperCase();
                    if (q >= 1 && q <= numQuestions && /[A-D]/.test(letter)) answers[q] = letter;
                }
            }
            return answers;
        }

        async function parseStudentAnswersVision(model, imageBase64Data, answerKey) {
            const numQuestions = Object.keys(answerKey).length;
            const dummyLetters = ['B', 'C', 'A'];
            let exampleJson = '{\n  "answers": {\n';
            for (let i = 1; i <= numQuestions; i++) {
                exampleJson += `    "${i}": "${dummyLetters[(i - 1) % 3]}"${i < numQuestions ? ',' : ''}\n`;
            }
            exampleJson += '  }\n}';

            const prompt = `You are an expert handwriting analyst for student quizzes.

The image shows a multiple-choice test with questions 1‚Äì${numQuestions}.

Each question has a printed "Answer:" followed by a handwritten capital letter (A, B, or C only).

Carefully read the handwritten letter after each "Answer:".

Common confusions:
- B can look like 8, 13, 18, 6, two humps
- A can look like 4, o, weak crossbar
- C can look like (, o, O, U

Examine each question one by one and decide the most likely letter.

Then output EXACTLY and ONLY this JSON (example letters are placeholders ‚Äî replace with what you see):

${exampleJson}

No explanations, no markdown, nothing else.`;

            const response = await callVisionModel(model, prompt, imageBase64Data);
            return { answers: extractAnswersFromTextBlob(response, numQuestions), rawResponse: response };
        }

        function buildOcrLlmPrompt(ocrText, numQuestions) {
            const dummyLetters = ['B', 'C', 'A'];
            let exampleJson = '{\n  "answers": {\n';
            for (let i = 1; i <= numQuestions; i++) {
                exampleJson += `    "${i}": "${dummyLetters[(i - 1) % 3]}"${i < numQuestions ? ',' : ''}\n`;
            }
            exampleJson += '  }\n}';

            return `You are an expert at correcting OCR errors on handwritten quiz answers.

OCR text is noisy. Handwritten letters after "Answer:" are often misread:
- B ‚Üí 8, 13, 18, 6, 8., 13.
- A ‚Üí 4, A., a
- C ‚Üí (, c, o, O, U

OCR text:
"""
${ocrText}
"""

For questions 1‚Äì${numQuestions}, infer the intended A/B/C from context and common OCR errors.

Think step by step internally.

Then output EXACTLY and ONLY this JSON (example letters are placeholders ‚Äî replace with what you infer):

${exampleJson}

Nothing else.`;
        }

        function parseAnswerKey(keyStr) {
            const key = {};
            keyStr.split(',').forEach(part => {
                const match = part.trim().match(/(\d+)\s*[:=.]\s*([A-Da-d])/i);
                if (match) key[parseInt(match[1])] = match[2].toUpperCase();
            });
            return key;
        }

        function gradeAnswers(answerKey, studentAnswers) {
            const results = [];
            let correct = 0;
            const total = Object.keys(answerKey).length;
            for (const [qNum, correctAnswer] of Object.entries(answerKey)) {
                const studentAnswer = studentAnswers[qNum] || null;
                const isCorrect = studentAnswer === correctAnswer;
                if (isCorrect) correct++;
                results.push({ question: qNum, correct: correctAnswer, student: studentAnswer || '‚Äî', isCorrect });
            }
            return { items: results.sort((a, b) => parseInt(a.question) - parseInt(b.question)), correct, total, percentage: Math.round((correct / total) * 100) };
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadImageToCanvas(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        function binarizeCanvas(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                const val = gray > 150 ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = val;
            }
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        // Image upload handler
        document.getElementById('imageUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const preview = document.getElementById('imgPreview');
                preview.src = ev.target.result;
                preview.style.display = 'block';
                document.getElementById('uploadArea').classList.add('has-image');
                document.querySelector('.upload-placeholder').style.display = 'none';
                imageBase64 = ev.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        });

        // Button onclick handlers
        document.getElementById('ocrLlmBtn').onclick = () => startGrading('ocr-llm');
        document.getElementById('visionBtn').onclick = () => startGrading('vision');
        document.getElementById('validateBtn').onclick = () => startGrading('validate');

        async function startGrading(method) {
            if (!imageBase64) return alert('Upload and wait for the image to load first!');
            const answerKey = parseAnswerKey(document.getElementById('answerKey').value.trim());
            if (Object.keys(answerKey).length === 0) return alert('Enter a valid answer key');

            const textModel = getTextModel();
            const visionModel = getVisionModel();

            setButtonsDisabled(true);
            document.getElementById('output').style.display = 'none';

            try {
                let rawOcrText = '';
                let llmResponse = '';
                let visionResponse = '';
                let deepseekAnswers = null;
                let qwenAnswers = null;

                if (method === 'ocr-llm' || method === 'validate') {
                    if (!ocrReady) await initOCR();
                    showStatus('Cleaning image & running OCR...', '', 30);
                    let canvas = await loadImageToCanvas(document.getElementById('imageUpload').files[0]);
                    canvas = binarizeCanvas(canvas);
                    const { data: { text } } = await ocrWorker.recognize(canvas);
                    rawOcrText = text;
                }

                if (method === 'ocr-llm') {
                    showStatus('DeepSeek R1 analysing OCR text...', 'Running on NPU', 80);
                    llmResponse = await callTextModel(textModel, buildOcrLlmPrompt(rawOcrText, Object.keys(answerKey).length));
                    const studentAnswers = extractAnswersFromTextBlob(llmResponse, Object.keys(answerKey).length);
                    const results = gradeAnswers(answerKey, studentAnswers);
                    displayResults(method, results, studentAnswers, answerKey, rawOcrText, visionResponse, llmResponse);
                } else if (method === 'vision') {
                    showStatus('Qwen2.5-VL reading handwriting directly...', 'Maximum accuracy', 85, false, false, true, true);
                    const result = await parseStudentAnswersVision(visionModel, imageBase64, answerKey);
                    const studentAnswers = result.answers;
                    visionResponse = result.rawResponse;
                    const results = gradeAnswers(answerKey, studentAnswers);
                    displayResults(method, results, studentAnswers, answerKey, rawOcrText, visionResponse, llmResponse);
                } else if (method === 'validate') {
                    showStatus('DeepSeek R1 analysing OCR...', '', 60);
                    llmResponse = await callTextModel(textModel, buildOcrLlmPrompt(rawOcrText, Object.keys(answerKey).length));
                    deepseekAnswers = extractAnswersFromTextBlob(llmResponse, Object.keys(answerKey).length);

                    showStatus('Qwen2.5-VL cross-checking...', 'Final validation', 90, false, false, true, true);
                    const result = await parseStudentAnswersVision(visionModel, imageBase64, answerKey);
                    qwenAnswers = result.answers;
                    visionResponse = result.rawResponse;

                    const studentAnswers = { ...deepseekAnswers, ...qwenAnswers }; // vision wins
                    const results = gradeAnswers(answerKey, studentAnswers);
                    displayResults(method, results, studentAnswers, answerKey, rawOcrText, visionResponse, llmResponse, deepseekAnswers, qwenAnswers);
                }

                showStatus('Grading complete!', '', 100, false, true);
                setTimeout(hideStatus, 3000);
            } catch (err) {
                showStatus('Error: ' + err.message, '', null, true);
                console.error(err);
            }
            setButtonsDisabled(false);
        }

        function displayResults(method, results, studentAnswers, answerKey, rawOcrText, visionResponse, llmResponse, deepseekAnswers, qwenAnswers) {
            document.getElementById('output').style.display = 'block';

            const badgeHTML = method === 'ocr-llm' ? '<span class="method-badge method-ocr-llm">üß† OCR + DeepSeek R1 Distill Qwen 7B (NPU)</span>' :
                             method === 'vision' ? '<span class="method-badge method-vision">üëÅÔ∏è Vision AI (Qwen2.5-VL)</span>' :
                             '<span class="method-badge method-vision">‚úÖ Validation Mode ‚Äì DeepSeek R1 + Qwen2.5-VL (recommended)</span>';
            document.getElementById('methodBadge').innerHTML = badgeHTML;

            const emoji = results.percentage === 100 ? 'üåü' : results.percentage >= 80 ? 'üëè' : results.percentage >= 60 ? 'üëç' : 'üìö';
            document.getElementById('scoreBox').innerHTML = `<div class="score-card"><div class="score-value">${results.correct}/${results.total}</div><div class="score-percent">${results.percentage}% ${emoji}</div></div>`;

            let tableHTML = `<table><thead><tr><th>Q#</th><th>Correct</th><th>Detected</th><th>Result</th></tr></thead><tbody>`;
            results.items.forEach(r => {
                tableHTML += `<tr class="${r.isCorrect ? 'correct' : 'incorrect'}">
                    <td>${r.question}</td><td><strong>${r.correct}</strong></td><td>${r.student}</td><td>${r.isCorrect ? '‚úì' : '‚úó'}</td>
                </tr>`;
            });
            tableHTML += `</tbody></table>`;
            document.getElementById('gradeTable').innerHTML = tableHTML;

            let debugHTML = '<h4>Final Answers:</h4><div class="detected-answers">';
            for (const [q, a] of Object.entries(studentAnswers)) {
                debugHTML += `<span class="detected-answer ${answerKey[q] === a ? 'matched' : 'unmatched'}">Q${q}: ${a}</span>`;
            }
            debugHTML += '</div>';

            debugHTML += `<h4>API Configuration:</h4><pre>Base URL: ${getApiBase()}\nText Model: ${getTextModel()}\nVision Model: ${getVisionModel()}</pre>`;

            if (rawOcrText) debugHTML += `<h4>Cleaned OCR Text:</h4><pre>${escapeHtml(rawOcrText.substring(0, 2000))}</pre>`;
            if (llmResponse) debugHTML += `<h4>DeepSeek R1 Response:</h4><pre>${escapeHtml(llmResponse)}</pre>`;
            if (visionResponse) debugHTML += `<h4>Qwen2.5-VL Response:</h4><pre>${escapeHtml(visionResponse)}</pre>`;

            if (method === 'validate') {
                if (deepseekAnswers) debugHTML += '<h4>DeepSeek Answers:</h4><div class="detected-answers">' + Object.entries(deepseekAnswers).map(([q,a]) => `<span class="detected-answer ${answerKey[q] === a ? 'matched' : 'unmatched'}">Q${q}: ${a}</span>`).join('') + '</div>';
                if (qwenAnswers) debugHTML += '<h4>Qwen Answers:</h4><div class="detected-answers">' + Object.entries(qwenAnswers).map(([q,a]) => `<span class="detected-answer ${answerKey[q] === a ? 'matched' : 'unmatched'}">Q${q}: ${a}</span>`).join('') + '</div>';
            }

            document.getElementById('debugContent').innerHTML = debugHTML;
        }

        // Auto-check connection on load
        window.addEventListener('load', () => {
            setTimeout(listModels, 500);
        });
    </script>
</body>
</html>
